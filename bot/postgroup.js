const puppeteer=require("puppeteer"),fs=require("fs").promises,path=require("path"),config=require("../config/configpostgroup.json"),fetch=require("node-fetch"),VALIDATION_SERVER_URL="https://license-server-botnews.vercel.app/api/validate",PRODUCT_NAME="autokomenfb";async function checkLicense(){console.log("Memulai validasi lisensi...");const t=process.env.BOT_LICENSE_EMAIL;if(!t)throw new Error("KESALAHAN: GitHub Secret 'BOT_LICENSE_EMAIL' tidak ditemukan.");const e=`${VALIDATION_SERVER_URL}?email=${encodeURIComponent(t)}&product=${PRODUCT_NAME}`;try{const t=await fetch(e),a=await t.json();if(t.ok&&"valid"===a.status)return console.log("‚úÖ Lisensi valid."),!0;throw new Error(`Lisensi tidak valid - Pesan dari server: ${a.message||"Tidak ada pesan"}`)}catch(t){throw new Error(`Gagal menghubungi server lisensi: ${t.message}`)}}const TARGET_GROUPS_PATH=path.join(__dirname,"../target_groups.txt"),POST_CONTENT_PATH=path.join(__dirname,"../post_content.txt"),LAST_CONTENT_INDEX_PATH=path.join(__dirname,"../last_content_index.txt"),ARTIFACTS_DIR=path.join(__dirname,"../artifacts"),delay=t=>new Promise(e=>setTimeout(e,t)),getRandomInterval=()=>1e3*(Math.floor(Math.random()*(config.maxIntervalSeconds-config.minIntervalSeconds+1))+config.minIntervalSeconds);async function loadCookiesFromEnv(){const t=process.env.FACEBOOK_COOKIES;if(!t)throw new Error("Secret FACEBOOK_COOKIES belum diatur di GitHub!");return JSON.parse(t).map(t=>({name:t.name,value:t.value,domain:t.domain,path:t.path}))}async function loadTargetGroups(){try{return(await fs.readFile(TARGET_GROUPS_PATH,"utf8")).split("\n").filter(t=>""!==t.trim())}catch(t){if("ENOENT"===t.code)throw new Error("File target_groups.txt tidak ditemukan!");throw t}}async function loadPostContent(){try{return(await fs.readFile(POST_CONTENT_PATH,"utf8")).split("---").map(t=>t.trim()).filter(t=>t)}catch(t){if("ENOENT"===t.code)throw new Error("File post_content.txt tidak ditemukan!");throw t}}async function loadLastContentIndex(){try{const t=await fs.readFile(LAST_CONTENT_INDEX_PATH,"utf8");return parseInt(t.trim(),10)}catch(t){return 0}}async function saveLastContentIndex(t){await fs.writeFile(LAST_CONTENT_INDEX_PATH,String(t),"utf8")}async function main(){let t;try{await checkLicense(),console.log("üöÄ Memulai bot Auto Posting Grup..."),await fs.mkdir(ARTIFACTS_DIR,{recursive:!0});const e=await loadTargetGroups(),a=await loadPostContent();let o=await loadLastContentIndex();if(0===e.length)return void console.log("Tidak ada grup target di file target_groups.txt. Bot berhenti.");if(0===a.length)return void console.log("File post_content.txt kosong. Bot berhenti.");t=await puppeteer.launch({headless:config.headless,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage"]});const n=await t.newPage();await n.setViewport({width:1280,height:800}),console.log("üîë Memuat cookies...");const i=await loadCookiesFromEnv();await n.setCookie(...i),console.log(`‚úÖ ${i.length} cookies berhasil dimuat.`);for(const t of e)try{const e=a[o%a.length];console.log(`\nNavigasi ke grup: ${t}`),console.log(`Konten yang akan diposting (konten ke-${o%a.length+1}):`),await n.goto(t,{waitUntil:"networkidle2"}),await delay(7e3),console.log("Mencari area untuk membuat postingan...");const i='xpath/ //div[@role="button" and (.//span[contains(text(), "Write something...")] or .//span[contains(text(), "Tulis sesuatu")])]';await n.waitForSelector(i,{timeout:15e3});const r=await n.$(i);await r.click(),console.log("‚úÖ Area postingan awal diklik."),await delay(3e3),console.log("Mencari kotak teks di dalam pop-up...");const s="p.xdj266r.x14z9mp.xat24cr.x1lziwak";await n.waitForSelector(s,{timeout:1e4}),await n.click(s),console.log("‚úÖ Kotak teks <p> difokuskan."),console.log("Mengetik konten postingan...");const l=e.split("\n");for(const t of l)await n.keyboard.type(t,{delay:50}),await n.keyboard.down("Shift"),await n.keyboard.press("Enter"),await n.keyboard.up("Shift");console.log(`üïí Menunggu ${config.linkPreviewIntervalSeconds} detik untuk pratinjau link...`),await delay(1e3*config.linkPreviewIntervalSeconds);const c='div[aria-label="Post"][role="button"], div[aria-label="Posting"][role="button"]';console.log('Mencari tombol "Post"...'),await n.waitForSelector(c,{timeout:1e4,visible:!0});const d=await n.$(c);await d.click(),console.log(`‚úÖ Berhasil posting ke: ${t}`),o++;const u=getRandomInterval();console.log(`üïí Jeda selama ${u/1e3} detik sebelum ke grup berikutnya...`),await delay(u)}catch(a){console.error(`‚ùå Gagal posting ke ${t}: ${a.message}`),await n.screenshot({path:path.join(ARTIFACTS_DIR,`error_grup_${e.indexOf(t)}.png`)})}await saveLastContentIndex(o)}catch(t){console.error("Terjadi error fatal:",t.message),process.exit(1)}finally{t&&await t.close(),console.log("üèÅ Bot selesai.")}}main();
